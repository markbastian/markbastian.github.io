<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>(conj community thoughts): Another Tetris Clone in Clojure</title>
    <link rel="canonical" href="https://markbastian.github.io/posts-output/2016-04-07-tetris/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700' rel='stylesheet'
          type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <script src="http://platform.twitter.com/widgets.js" type="text/javascript" async defer></script>
    <script src="http://platform.linkedin.com/in.js" type="text/javascript" async defer></script>
    <script type="text/javascript" src="https://platform.linkedin.com/badges/js/profile.js" async defer></script>
    <!--For Google Analytics-->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-89196403-1', 'auto');
        ga('send', 'pageview');
    </script>
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
    <link href="/css/tables.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">(conj community thoughts)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages-output/about/">About</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li class="dropdown-header">Links</li>
                        <!--<li><a href="http://cryogenweb.org/docs/home.html">Cryogen Docs</a></li>-->
                        <!--<li><a href="http://carmenla.me/blog/archives">Carmen's Blog</a></li>-->
                        
                        <li><a href="/pages-output/presentations/">Presentations</a></li>
                        
                        <li><a href="/pages-output/projects/">Projects</a></li>
                        
                        <li><a href="/pages-output/links/">Links</a></li>
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts-output/2017-07-10-polymacro/">A Polynomial Macro</a></li>
                        
                        <li><a href="/posts-output/2017-06-19-clojure-rising/">Clojure Rising</a></li>
                        
                        <li><a href="/posts-output/2016-04-07-tetris/">Another Tetris Clone in Clojure</a></li>
                        
                        <li><a href="/posts-output/2015-12-01-gettingstarted/">Clojure: Getting Started</a></li>
                        
                        <li><a href="/posts-output/2015-10-26-concerns/">My Concern with Concerns</a></li>
                        
                        <li><a href="/posts-output/2015-09-24-state-mgmt/">Clojure State Management by Example</a></li>
                        
                        <li><a href="/posts-output/2015-08-25-snake/">A Clojure Snake Game</a></li>
                        
                        <li><a href="/posts-output/2015-08-06-homoiconic/">Clojure is Homoiconic, Java is Not</a></li>
                        
                        <li><a href="/posts-output/2015-07-22-three/">Three Reasons You May Not Want to Learn Clojure</a></li>
                        
                        <li><a href="/posts-output/2015-07-14-quilwora/">Quil, Clojure, and WORA</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags-output/scala/">scala</a></li>
                        
                        <li><a href="/tags-output/quil/">quil</a></li>
                        
                        <li><a href="/tags-output/clojure/">clojure</a></li>
                        
                        <li><a href="/tags-output/differential equations/">differential equations</a></li>
                        
                        <li><a href="/tags-output/java/">java</a></li>
                        
                        <li><a href="/tags-output/math/">math</a></li>
                        
                        <li><a href="/tags-output/functional programming/">functional programming</a></li>
                        
                        <li><a href="/tags-output/mazes/">mazes</a></li>
                        
                        <li><a href="/tags-output/concurrency/">concurrency</a></li>
                        
                        <li><a href="/tags-output/numerical analysis/">numerical analysis</a></li>
                        
                        <li><a href="/tags-output/juxt/">juxt</a></li>
                        
                        <li><a href="/tags-output/clojurescript/">clojurescript</a></li>
                        
                        <li><a href="/tags-output/conway/">conway</a></li>
                        
                        <li><a href="/tags-output/defmacro/">defmacro</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">April 7, 2016</div>
        
    </div>
    <h2>Another Tetris Clone in Clojure</h2>
</div>
<div>
    <ol class="content"><li><a href="#introduction">Introduction</a></li><li><a href="#data_first_design">Data First Design</a></li><ol><li><a href="#implicit_board_representation">Implicit Board Representation</a></li><li><a href="#moves">Moves</a></li><li><a href="#clearing_rows">Clearing Rows</a></li><li><a href="#bringing_it_all_together">Bringing It All Together</a></li></ol><li><a href="#conclusion">Conclusion</a></li></ol>
     <h2 id="introduction">Introduction</h2><p>Recently I was looking at a problem involving extracting and transposing submatrices of data within a larger data grid. Somehow this got me thinking how easy it would be to rotate <a href='https://en.wikipedia.org/wiki/Tetromino'>tetrominos</a> using Clojure. In case you are wondering, it is super easy:</p><pre><code class="clojure">&#40;defn rotate-ccw &#91;shape&#93; 
  &#40;apply mapv vector &#40;map rseq shape&#41;&#41;&#41;

&#40;defn rotate-cw &#91;shape&#93; 
  &#40;apply mapv &#40;comp vec rseq vector&#41; shape&#41;&#41;
</code></pre><p>These two functions will rotate a tetromino counterclockwise and clockwise, respectively. No math required.</p><p>After doing this trivial exercise I soon found myself asking myself "How fast can I code up Tetris in Clojure." It turns out that the answer is "pretty fast." Let me first say that this is not a new idea. It has been done <a href='http://timothypratley.blogspot.com/2015/07/you-should-be-using-figwheelreagent.html'>here</a> and <a href='https://github.com/yogthos/clj-tetris'>here</a> as well. I still thought it would be fun, so here is my solution along with some insights.</p><p>Here's the game. Press the left and right arrow keys to translate, up and down arrows to rotate, and the space bar to make the the tetromino immediately fall into place.</p><p><div id="app"> <script src="../../js/tetris.js"></script></p><p>Read on to learn more about how the game was actually written.</p><h2 id="data&#95;first&#95;design">Data First Design</h2><p>As anyone who has seen my <a href='https://www.youtube.com/watch?v=Tb823aqgX_0"'>Clojure/conj video</a> or talked to me knows, I believe the best approach to coding a solution to a problem is to model the data literally rather than design an API to represent the data. Why model a domain when you can represent it directly instead? Clojure is made for this approach. This exercise is no different, as the first step is to model the shapes as maps of vector literals. Rather than making some sort of base "Tetromino" class and extending a bunch of methods and having some field that loads a bitmap or some such nonsense, I just did what you see here:</p><pre><code class="clojure">&#40;def shapes
  {:I &#91;&#91;0 0 0 0&#93;
       &#91;1 1 1 1&#93;
       &#91;0 0 0 0&#93;
       &#91;0 0 0 0&#93;&#93;
   :J &#91;&#91;0 0 0&#93;
       &#91;1 1 1&#93;
       &#91;0 0 1&#93;&#93;
   :L &#91;&#91;0 0 0&#93;
       &#91;1 1 1&#93;
       &#91;1 0 0&#93;&#93;
   :O &#91;&#91;1 1&#93;
       &#91;1 1&#93;&#93;
   :S &#91;&#91;0 0 0&#93;
       &#91;0 1 1&#93;
       &#91;1 1 0&#93;&#93;
   :T &#91;&#91;0 0 0&#93;
       &#91;1 1 1&#93;
       &#91;0 1 0&#93;&#93;
   :Z &#91;&#91;1 1 0&#93;
       &#91;0 1 1&#93;
       &#91;0 0 0&#93;&#93;}&#41;
</code></pre><p>Pretty cool, eh? You can look right at the shape entries and see the shapes as they are encoded in the data structures as 1s in a field of 0s. Of course, the current shape will be translating and rotating during the game, so I must keep track of that. I also want to track a few other game values, such as the current score, high score, values to keep track of when a tetromino falls, as well as the cells that are currently locked into place.</p><p>This can all be captured in a single function that generates an initial state representing a complete value for the game.</p><pre><code class="clojure">&#40;defn initial-state &#91;&#93;
  {:frame 0
   :speed 50
   :score 0
   :high-score 0
   :locked #{}
   :shape-pos &#91;&#40;rand-int 7&#41; 0&#93;
   :shape &#40;&#40;rand-nth &#40;keys shapes&#41;&#41; shapes&#41;}&#41;
</code></pre><p>The data structure above completely represents all of the values I need to keep track of for my entire game. The most interesting entries are locked, shape-pos, and shape. locked is a set of coordinates in the board that contain locked cells. shape-pos is the upper left hand coordinate of the current tetramino. shape is the current falling tetramino shape. Note that I do not keep track of rotation. I just rotate the piece in place.</p><p>At this point, all that remains is filling in some functions and methods around this data for user interaction, game rules, and rendering. Here are some of the details.</p><h3 id="implicit&#95;board&#95;representation">Implicit Board Representation</h3><p>Rather than taking the usual approach of creating an MxN grid, I implicitly represent the board by using rules for boundaries (nothing can be outside of the board dimensions) and a hash set to represent the blocks currently "locked in" to the board. This definition looks like this:</p><pre><code class="clojure">&#40;defn valid? &#91;{:keys &#91;locked&#93; :as state}&#93;
  &#40;every? &#40;fn &#91;&#91;x y :as c&#93;&#93;
            &#40;and &#40;&#40;complement locked&#41; c&#41; 
                 &#40;&lt;= 0 x 9&#41; &#40;&lt; y 22&#41;&#41;&#41;
          &#40;shape-coords state&#41;&#41;&#41;
</code></pre><p>Basically, for every coordinate in the current falling shape (The shape-coords function) I check to see if it is within the game's x-y grid and if it is not contained in the locked set of cells.</p><p>Speaking of computing the coordinates of the current shape, this is something I'll do a lot, so here's a handy function to do it:</p><pre><code class="clojure">&#40;defn shape-coords &#91;{:keys &#91;shape-pos shape&#93;}&#93;
  &#40;let &#91;d &#40;count shape&#41;&#93;
    &#40;for &#91;i &#40;range d&#41; j &#40;range d&#41; 
          :when &#40;= 1 &#40;get-in shape &#91;i j&#93;&#41;&#41;&#93;
      &#40;mapv + &#91;i j&#93; shape-pos&#41;&#41;&#41;&#41;
</code></pre><p>This function destructures the current shape position and shape cells from the game and returns the coordinates of the 4 cells in the shape (the 1s).</p><h3 id="moves">Moves</h3><p>Given the above representations, the game reduces down to making valid tetromino moves within the board. There are two scenarios for moving a tetromino:</p><ol><li>The user moves it (This does not include the user making the tetromino fall faster). A user can translate or rotate a tetromino. The only thing the game must do when a user performs a translation or rotation is see if the new piece is in a valid location. If it is you accept the new value, if not you just reject the move.</li><li>It is falling. When a tetromino falls (either over time or by a user forcing it to fall faster) there is only one thing to consider: Is the new position overlapping the set of locked blocks? If so, we do not allow the tetromino to fall, but instead add the former grid positions of the tetromino to the locked block set.A key point here is that rather than allowing invalid operations to be performed and throwing exceptions or other similar mechanisms, this program simply rejects any invalid operations and always maintains a valid value for the current state.</li></ol><p>Here are the functions for piece translation and rotation:</p><pre><code class="clojure">&#40;defn x-shift &#91;state f&#93;
  &#40;let &#91;shifted &#40;update-in state &#91;:shape-pos 0&#93; f&#41;&#93;
    &#40;if &#40;valid? shifted&#41; shifted state&#41;&#41;&#41;

&#40;defn rotate &#91;state f&#93;
  &#40;let &#91;shifted &#40;update state :shape f&#41;&#93;
    &#40;if &#40;valid? shifted&#41; shifted state&#41;&#41;&#41;
</code></pre><p>In the above code x-shift means "translate shift" and f is a function to be applied to the shape position (either inc or dec for right or left translation, respectively). rotate takes on of the two rotation functions I defined at the beginning of this post.</p><p>For falling, the logic is a bit more complex:</p><pre><code class="clojure">&#40;defn fall &#91;state&#93;
  &#40;let &#91;shifted &#40;update-in state &#91;:shape-pos 1&#93; inc&#41;&#93;
    &#40;if &#40;valid? shifted&#41;
      shifted
      &#40;let &#91;locked-coords &#40;shape-coords state&#41;&#93;
        &#40;-&gt; state
            &#40;update :locked into locked-coords&#41;
            &#40;score 1&#41;
            &#40;#&#40;reduce clear-row % &#40;map second locked-coords&#41;&#41;&#41;
            &#40;into { :shape &#40;&#40;rand-nth &#40;keys shapes&#41;&#41; shapes&#41;
                   :shape-pos &#91;&#40;rand-int 7&#41; 0&#93;}&#41;&#41;&#41;&#41;&#41;&#41;
</code></pre><p>Again, we first do a simple shift. If it is valid, we are done. If it isn't valid that means we've either moved off the bottom of the board or intersected with existing locked pieces. Either way, we lock the unshifted cells into the board and then check to see if rows need clearing. Finally, we add in a new random shape at the top of the board. I also give the player a point when a cell locks.</p><p>The player can also execute a fast drop in which they have a piece prepositioned and want it to immediately lock so they can get the next piece. This is as simple as:</p><pre><code class="clojure">&#40;defn fast-drop &#91;{:keys &#91;locked&#93; :as state}&#93;
  &#40;some #&#40;when &#40;not= locked &#40;:locked %&#41;&#41; %&#41; 
        &#40;iterate fall state&#41;&#41;&#41;
</code></pre><p>The function iterates over the current state with the fall function until the set of locked set of cells change. This will occur when the falling piece can no longer fall.</p><h3 id="clearing&#95;rows">Clearing Rows</h3><p>Clearing a row occurs when all every cell in a row is locked. When this occurs, state is threaded such that 10 points are awarded, the speed is decreased (more on this in the next section), and cells are kept, removed, or shifted depending on their relation to the row to be removed.</p><pre><code class="clojure">&#40;defn clear-row &#91;{:keys &#91;locked&#93; :as state} row&#93;
  &#40;if &#40;every? locked &#40;for &#91;i &#40;range 10&#41;&#93; &#91;i row&#93;&#41;&#41;
    &#40;-&gt; state
        &#40;score 10&#41;
        &#40;update :speed dec&#41;
        &#40;assoc :locked
               &#40;set &#40;for &#91;&#91;i j&#93; locked :when &#40;not= j row&#41;&#93;
                      &#40;if &#40;&lt; j row&#41; &#91;i &#40;inc j&#41;&#93; &#91;i j&#93;&#41;&#41;&#41;&#41;&#41;
    state&#41;&#41;
</code></pre><h3 id="bringing&#95;it&#95;all&#95;together">Bringing It All Together</h3><p>The final function needed is a game-step function that is called by the user interface layer for each game time step. Here's the function:</p><pre><code class="clojure">&#40;defn game-step &#91;{:keys &#91;frame locked speed&#93; :as state}&#93;
  &#40;cond-&gt; &#40;update state :frame inc&#41;
          &#40;zero? &#40;mod frame &#40;max speed 1&#41;&#41;&#41;
          fall
          &#40;some zero? &#40;map second locked&#41;&#41;
          &#40;into &#40;dissoc &#40;initial-state&#41; :high-score&#41;&#41;&#41;&#41;
</code></pre><p>The function updates the frame at each time step then does some conditional threading at the new game step. First, if the frame modded with the current speed is zero, the tetromino falls. So, speed in this game is really a misnomer. Lower speed makes the tetromino fall more frequently. Finally, if any y coordinate in the locked cells is at 0 (I am using screen coordinates, so 0 is at the top of the screen going down) we reset the game but maintain the current high score.</p><p>A Complete Rule Set and a UI All of the above code in a single namespace completely defines the game engine. All that is needed is a user interface to display the current value and take user input. I won't go into the details of the UI in this post, but might later. However, here are a couple of high level details about the UI: I actually did 2 interfaces - one using Quil and one using Reagent. The one embedded here is the Reagent version. The Quil UI compiles to both Java and JavaScript where the Reagent version just compiles to JavaScript. The rules are written as cljc files so cross compile without issue. Either UI is only about 50-70 lines of code, so are pretty minimal.</p><h2 id="conclusion">Conclusion</h2><p>Once again, Clojure's ability to let me model a domain directly as data and then write functions to manipulate those domain values has yielded a simple and concise solution to a problem. I find it pretty amazing that I can write an entire game, including UI, in about 150 lines of code. Not only is the solution brief, but I think the simple function names and full-state representation of values makes the code pretty readable. Despite being a simple case in this post, I've found this technique to be quite useful in domains of any size or complexity. However, a key requirement for this approach is a language that has full support for modeling the domain as data. Clojure is an excellent fit as it was designed to be data first from inception.</p><p>The complete source for this project can be cloned <a href='https://github.com/markbastian/tetris'>here</a>.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/clojure/">clojure</a>
    
    <a href="/tags-output/functional programming/">functional programming</a>
    
    <a href="/tags-output/clojurescript/">clojurescript</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts-output/2017-06-19-clojure-rising/">&laquo; Clojure Rising</a>
        
        
        <a class="right" href="/posts-output/2015-12-01-gettingstarted/">Clojure: Getting Started &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://markbastian.github.io/posts-output/2016-04-07-tetris/";
            this.page.identifier = "Another Tetris Clone in Clojure";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//markbastian.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2018 Mark Bastian
        <a href="http://twitter.com/mark_bastian" class="twitter-follow-button" data-show-count="false">Follow @mark_bastian</a>
        <script type="IN/MemberProfile" data-id="https://www.linkedin.com/in/mark-bastian-295553102" data-format="click" data-related="false" data-text="Mark Bastian"></script>
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
 <link rel="stylesheet" type="text/css" href=nil>
<script>
window.klipse_settings = null;
</script>
<script src=nil></script> 

</body>
</html>
